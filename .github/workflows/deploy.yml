name: Build & Deploy Docker para Kubernetes (via SSH)

on:
  push:
    branches: [ "gui" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      NAMESPACE: lifeai
      DOCKER_USER: guisilva1k2k
      BACKEND_NAME: lifeai-backend
      BACKEND_TAG: latest

    steps:
      # 1ï¸âƒ£ Checkout do cÃ³digo
      - name: Checkout
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Configurar Docker Buildx
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ Login no Docker Hub usando secret
      - name: Login no DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4ï¸âƒ£ Build e push da imagem do backend
      - name: Build & Push Backend
        uses: docker/build-push-action@v6
        with:
          context: ./back
          push: true
          tags: |
            ${{ env.DOCKER_USER }}/${{ env.BACKEND_NAME }}:latest
            ${{ env.DOCKER_USER }}/${{ env.BACKEND_NAME }}:${{ github.sha }}

      # 5ï¸âƒ£ Atualizar deployment na instÃ¢ncia remota via SSH
      - name: Decodificar chave base64 para arquivo
        run: |
          echo "${{ secrets.REMOTE_SSH_KEY }}" | base64 --decode > ssh_key
          chmod 600 ssh_key

      - name: Atualizar deploys na instÃ¢ncia remota
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key_path: ssh_key
          debug: true
          script: |
            echo "âœ… Atualizando backend..."
            kubectl set image deployment/django-deployment backend=${{ env.DOCKER_USER }}/${{ env.BACKEND_NAME }}:${{ github.sha }} -n ${{ env.NAMESPACE }}
            kubectl rollout status deployment/django-deployment -n ${{ env.NAMESPACE }}
            echo "ðŸš€ Deploy concluÃ­do na instÃ¢ncia remota"


