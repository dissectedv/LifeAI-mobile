name: Build & Deploy Docker para Kubernetes (via SSH)

on:
  push:
    branches: [ "gui" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      NAMESPACE: lifeai
      DOCKER_USER: guisilva1k2k
      BACKEND_NAME: lifeai-backend
      BACKEND_TAG: latest

    steps:
      # 1Ô∏è‚É£ Checkout do c√≥digo
      - name: Checkout
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Configurar Docker Buildx
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3Ô∏è‚É£ Login no Docker Hub usando secret
      - name: Login no DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4Ô∏è‚É£ Build e push da imagem do backend
      - name: Build & Push Backend
        uses: docker/build-push-action@v6
        with:
          context: ./back
          push: true
          tags: |
            ${{ env.DOCKER_USER }}/${{ env.BACKEND_NAME }}:latest
            ${{ env.DOCKER_USER }}/${{ env.BACKEND_NAME }}:${{ github.sha }}

      # 5Ô∏è‚É£ Atualizar deployment na inst√¢ncia remota via SSH
      - name: Atualizar deploys na inst√¢ncia remota
        uses: appleboy/ssh-action@v0.1.9
        with:
          debug: true
          host: ${{ secrets.REMOTE_HOST }}      # IP da inst√¢ncia
          username: ${{ secrets.REMOTE_USER }}  # usu√°rio de servi√ßo
          key: ${{ secrets.REMOTE_SSH_KEY }}    # chave privada
          script: |
            echo "‚úÖ Atualizando backend..."
            
            kubectl set image deployment/django-deployment backend=${{ env.DOCKER_USER }}/${{ env.BACKEND_NAME }}:${{ github.sha }} -n ${{ env.NAMESPACE }}
            kubectl rollout status deployment/django-deployment -n ${{ env.NAMESPACE }}

            echo "üöÄ Deploy conclu√≠do na inst√¢ncia remota"
